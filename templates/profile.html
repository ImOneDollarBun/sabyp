<!DOCTYPE html>
<html lang="ru">

<head>
  <link rel="stylesheet" href="static/style/profile.css">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
</head>

<body>
  <header>
    <h1>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
  </header>
  <div class="container">
    <div class="grid">
      <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å —É—á—ë—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
      <div class="card">
        <h2>–£—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
        <label>Email<input type="email" id="email"></label>
        <label>Username<input type="text" id="username"></label>
        <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å<input type="password" id="password"></label>
        <button class="save-btn" id="saveUser">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>

      <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏ -->
      <div class="card">
        <h2 id="projectsHeader">–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã (0/5)</h2>
        <div class="project-list" id="projectList"></div>
        <button class="add-btn" id="addProject">+ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
      </div>
    </div>
  </div>

  <script>
    const maxProjects = 5;

    async function loadProfile() {
      try {
        const r = await fetch('/api/me');
        if (!r.ok) throw new Error('Failed to fetch profile');
        const d = await r.json();
        email.value = d.email;
        username.value = d.username;
        renderProjects(d.projects || []);
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', e);
      }
    }


    function renderProjects(projects) {
      const header = document.getElementById('projectsHeader');
      if (header) {
        header.textContent = `–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã (${projects.length}/${maxProjects})`;
      }

      const cont = document.getElementById('projectList');
      cont.innerHTML = '';

      if (projects.length === 0) {
        cont.innerHTML = '<p>–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤.</p>';
        return;
      }

      projects.forEach(p => {
        const card = document.createElement('div');
        card.className = 'project-card';

        const actions = document.createElement('div');
        actions.className = 'project-actions';

        const shareBtn = document.createElement('button');
        shareBtn.className = 'share-btn';
        shareBtn.title = '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è';
        shareBtn.textContent = 'üîó';

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.title = '–£–¥–∞–ª–∏—Ç—å';
        deleteBtn.textContent = '‚ùå';

        actions.appendChild(shareBtn);
        actions.appendChild(deleteBtn);

        const content = document.createElement('div');
        content.className = 'project-content';

        const title = document.createElement('h3');
        title.textContent = p.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

        const desc = document.createElement('p');
        desc.className = 'description';
        desc.textContent = p.description || '';

        content.appendChild(title);
        content.appendChild(desc);

        card.appendChild(actions);
        card.appendChild(content);

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        card.addEventListener('click', e => {
          if (e.target.classList.contains('delete-btn')) {
            e.stopPropagation();
            deleteProject(p.id);
          } else if (e.target.classList.contains('share-btn')) {
            e.stopPropagation();
            fetch(`/project/share/${p.id}`)
              .then(r => r.json())
              .then(link => {
                navigator.clipboard.writeText(link.slug);
              })
              .catch(() => alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É'));
          } else {
            location.href = `/projects/${p.id}/edit`;
          }
        });

        cont.appendChild(card);
      });


      document.getElementById('addProject').disabled = projects.length >= maxProjects;
    }


    async function deleteProject(id) {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?')) return;
      await fetch(`/api/projects/${id}`, { method: 'DELETE' });
      loadProfile();  // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
    addProject.onclick = async () => {
      const resp = await fetch('/api/projects', { method: 'POST' });
      if (resp.redirected) {
        location.href = resp.url;  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
      } else {
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç');
      }
    };

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    saveUser.onclick = async () => {
      await fetch('/api/me', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          email: email.value,
          username: username.value,
          password: password.value
        })
      });
      alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      password.value = '';  // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
    };

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    loadProfile();
  </script>
</body>

</html>